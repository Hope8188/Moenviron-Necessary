-- Bootstrap the first admin role when the first profile is created

CREATE OR REPLACE FUNCTION public.handle_first_admin()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- Only assign admin if no admin exists yet
  IF NOT EXISTS (
    SELECT 1
    FROM public.user_roles
    WHERE role = 'admin'::public.app_role
  ) THEN
    INSERT INTO public.user_roles (user_id, role)
    VALUES (NEW.user_id, 'admin'::public.app_role);
  END IF;

  RETURN NEW;
END;
$$;

DROP TRIGGER IF EXISTS on_first_admin_assignment ON public.profiles;

CREATE TRIGGER on_first_admin_assignment
AFTER INSERT ON public.profiles
FOR EACH ROW
EXECUTE FUNCTION public.handle_first_admin();
